<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aadhaar Family Survey App</title>
    
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.23.0/app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.23.0/auth.js"></script>
    
    <!-- Tesseract.js -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    
    <!-- Cropper.js -->
    <link href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    
    <!-- SheetJS -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary-color: #3b82f6;
            --primary-dark: #1e40af;
            --secondary-color: #10b981;
            --accent-color: #f59e0b;
            --danger-color: #ef4444;
            --bg-light: #f8fafc;
            --bg-dark: #0f172a;
            --text-light: #1e293b;
            --text-dark: #f1f5f9;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
        }
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .dark {
            --bg-light: #0f172a;
            --bg-dark: #1e293b;
            --text-light: #f1f5f9;
            --text-dark: #64748b;
        }
        
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .glass-button {
            background: linear-gradient(135deg, var(--glass-bg), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            transition: all 0.3s ease;
        }
        
        .glass-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.5);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .floating-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .speech-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .speech-btn:hover {
            transform: scale(1.1);
        }
        
        .speech-btn.recording {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
        }
        
        .family-tree {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .family-member {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 15px;
            margin: 10px;
            min-width: 200px;
            text-align: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
        }
        
        .cropper-container {
            max-height: 400px;
        }
        
        /* PWA Styles */
        .pwa-install {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
        }
        
        /* Responsive design for PDF export */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .print-break {
                page-break-after: always;
            }
            
            body {
                font-size: 12px;
            }
            
            .glass-card, .stat-card {
                background: white !important;
                border: 1px solid #ccc !important;
                box-shadow: none !important;
            }
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }
        
        /* Language support */
        .hindi {
            font-family: 'Devanagari Sangam MN', 'Noto Sans Devanagari', sans-serif;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900 min-h-screen">
    <!-- Toast Notifications -->
    <div id="toast" class="toast glass-card p-4 text-white max-w-sm">
        <div class="flex items-center">
            <i id="toastIcon" class="fas fa-info-circle mr-3"></i>
            <span id="toastMessage">Message</span>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="glass-card p-8 text-center text-white">
            <div class="loader mx-auto mb-4"></div>
            <p id="loadingText">Loading...</p>
        </div>
    </div>
    
    <!-- Firebase Auth Container -->
    <div id="authContainer" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass-card p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <i class="fas fa-id-card text-6xl text-blue-400 mb-4"></i>
                <h1 class="text-3xl font-bold text-white mb-2">Aadhaar Survey</h1>
                <p class="text-gray-300">BLO Family Survey System</p>
            </div>
            
            <div id="phoneAuthContainer">
                <div class="mb-6">
                    <label class="block text-white mb-2">Phone Number</label>
                    <div class="flex">
                        <span class="inline-flex items-center px-3 rounded-l-md bg-gray-700 text-white">+91</span>
                        <input type="tel" id="phoneNumber" class="flex-1 px-4 py-3 rounded-r-md bg-gray-800 text-white border border-gray-600 focus:border-blue-500 focus:outline-none" placeholder="Enter 10-digit mobile number" maxlength="10">
                    </div>
                </div>
                
                <div id="recaptcha-container" class="mb-6"></div>
                
                <button id="sendOtpBtn" class="w-full glass-button text-white font-semibold py-3 px-6 rounded-lg">
                    <i class="fas fa-paper-plane mr-2"></i>Send OTP
                </button>
            </div>
            
            <div id="otpVerificationContainer" class="hidden">
                <div class="mb-6">
                    <label class="block text-white mb-2">Enter OTP</label>
                    <input type="text" id="otpCode" class="w-full px-4 py-3 rounded-md bg-gray-800 text-white border border-gray-600 focus:border-blue-500 focus:outline-none text-center text-2xl tracking-widest" placeholder="000000" maxlength="6">
                </div>
                
                <button id="verifyOtpBtn" class="w-full glass-button text-white font-semibold py-3 px-6 rounded-lg mb-4">
                    <i class="fas fa-shield-alt mr-2"></i>Verify OTP
                </button>
                
                <button id="resendOtpBtn" class="w-full text-blue-400 hover:text-blue-300 text-sm">
                    Resend OTP
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main Application -->
    <div id="mainApp" class="hidden min-h-screen">
        <!-- Header -->
        <header class="glass-card m-4 p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-users text-2xl text-blue-400 mr-3"></i>
                    <h1 class="text-xl font-bold text-white" data-en="Aadhaar Family Survey" data-hi="आधार पारिवारिक सर्वेक्षण">Aadhaar Family Survey</h1>
                </div>
                
                <div class="flex items-center space-x-4">
                    <span id="userInfo" class="text-white text-sm"></span>
                    <button id="logoutBtn" class="glass-button text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Navigation Tabs -->
        <nav class="glass-card m-4 p-2">
            <div class="flex flex-wrap justify-center space-x-2">
                <button class="tab-btn active px-4 py-2 rounded-lg text-white glass-button mb-2" data-tab="addMember">
                    <i class="fas fa-user-plus mr-2"></i><span data-en="Add Member" data-hi="सदस्य जोड़ें">Add Member</span>
                </button>
                <button class="tab-btn px-4 py-2 rounded-lg text-white glass-button mb-2" data-tab="familyView">
                    <i class="fas fa-home mr-2"></i><span data-en="Family View" data-hi="पारिवारिक दृश्य">Family View</span>
                </button>
                <button class="tab-btn px-4 py-2 rounded-lg text-white glass-button mb-2" data-tab="dashboard">
                    <i class="fas fa-chart-bar mr-2"></i><span data-en="Dashboard" data-hi="डैशबोर्ड">Dashboard</span>
                </button>
                <button class="tab-btn px-4 py-2 rounded-lg text-white glass-button mb-2" data-tab="exportImport">
                    <i class="fas fa-download mr-2"></i><span data-en="Export/Import" data-hi="निर्यात/आयात">Export/Import</span>
                </button>
                <button class="tab-btn px-4 py-2 rounded-lg text-white glass-button mb-2" data-tab="settings">
                    <i class="fas fa-cog mr-2"></i><span data-en="Settings" data-hi="सेटिंग्स">Settings</span>
                </button>
            </div>
        </nav>
        
        <!-- Tab Contents -->
        <div class="m-4">
            <!-- Add Member Tab -->
            <div id="addMember" class="tab-content active">
                <div class="glass-card p-6">
                    <h2 class="text-2xl font-bold text-white mb-6" data-en="Add Family Member" data-hi="पारिवारिक सदस्य जोड़ें">Add Family Member</h2>
                    
                    <!-- Aadhaar Image Upload Section -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-white mb-4" data-en="Upload Aadhaar Card" data-hi="आधार कार्ड अपलोड करें">Upload Aadhaar Card</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Front Side -->
                            <div class="glass-card p-4">
                                <h4 class="text-white mb-3" data-en="Front Side" data-hi="आगे का भाग">Front Side</h4>
                                <div class="space-y-3">
                                    <input type="file" id="aadhaarFront" accept="image/*" class="w-full text-white bg-gray-800 border border-gray-600 rounded-lg p-2">
                                    <button id="captureFront" class="w-full glass-button text-white py-2 rounded-lg">
                                        <i class="fas fa-camera mr-2"></i><span data-en="Capture Photo" data-hi="फोटो खींचें">Capture Photo</span>
                                    </button>
                                    <div id="frontPreview" class="hidden">
                                        <img id="frontImage" class="w-full rounded-lg mb-2" alt="Front Preview">
                                        <button id="cropFront" class="w-full glass-button text-white py-2 rounded-lg">
                                            <i class="fas fa-crop mr-2"></i><span data-en="Crop & Rotate" data-hi="क्रॉप और घुमाएं">Crop & Rotate</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Back Side -->
                            <div class="glass-card p-4">
                                <h4 class="text-white mb-3" data-en="Back Side" data-hi="पीछे का भाग">Back Side</h4>
                                <div class="space-y-3">
                                    <input type="file" id="aadhaarBack" accept="image/*" class="w-full text-white bg-gray-800 border border-gray-600 rounded-lg p-2">
                                    <button id="captureBack" class="w-full glass-button text-white py-2 rounded-lg">
                                        <i class="fas fa-camera mr-2"></i><span data-en="Capture Photo" data-hi="फोटो खींचें">Capture Photo</span>
                                    </button>
                                    <div id="backPreview" class="hidden">
                                        <img id="backImage" class="w-full rounded-lg mb-2" alt="Back Preview">
                                        <button id="cropBack" class="w-full glass-button text-white py-2 rounded-lg">
                                            <i class="fas fa-crop mr-2"></i><span data-en="Crop & Rotate" data-hi="क्रॉप और घुमाएं">Crop & Rotate</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 text-center">
                            <button id="extractDataBtn" class="glass-button text-white px-6 py-3 rounded-lg font-semibold">
                                <i class="fas fa-magic mr-2"></i><span data-en="Extract Data with OCR" data-hi="OCR के साथ डेटा निकालें">Extract Data with OCR</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Member Details Form -->
                    <form id="memberForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-white mb-2" data-en="Full Name" data-hi="पूरा नाम">Full Name</label>
                                <div class="flex">
                                    <input type="text" id="memberName" class="flex-1 px-4 py-3 rounded-l-md bg-gray-800 text-white border border-gray-600 focus:border-blue-500 focus:outline-none" placeholder="Enter full name" required>
                                    <button type="button" class="speech-btn rounded-r-md" data-field="memberName">
                                        <i class="fas fa-microphone"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-white mb-2" data-en="Date of Birth" data-hi="जन्म तिथि">Date of Birth</label>
                                <input type="date" id="memberDob" class="w-full px-4 py-3 rounded-md bg-gray-800 text-white border border-gray-600 focus:border-blue-500 focus:outline-none" required>
                            </div>
                            
                            <div>
                                <label class="block text-white mb-2" data-en="Aadhaar Number" data-hi="आधार संख्या">Aadhaar Number</label>
                                <input type="text" id="memberAadhaar" class="w-full px-4 py-3 rounded-md bg-gray-800 text-white border border-gray-600 focus:border-blue-500 focus:outline-none" placeholder="XXXX XXXX XXXX" maxlength="14" required>
                            </div>
                            
                            <div>
                                <label class="block text-white mb-2" data-en="Gender" data-hi="लिंग">Gender</label>
                                <select id="memberGender" class="w-full px-4 py-3 rounded-md bg-gray-800 text-white border border-gray-600 focus:border-blue-500 focus:outline-none" required>
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male / पुरुष</option>
                                    <option value="Female">Female / महिला</option>
                                    <option value="Other">Other / अन्य</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-white mb-2" data-en="Mobile Number" data-hi="मोबाइल नंबर">Mobile Number</label>
                                <input type="tel" id="memberMobile" class="w-full px-4 py-3 rounded-md bg-gray-800 text-white border border-gray-600 focus:border-blue-500 focus:outline-none" placeholder="Enter mobile number" maxlength="10">
                            </div>
                            
                            <div>
                                <label class="block text-white mb-2" data-en="Caste Category" data-hi="जाति श्रेणी">Caste Category</label>
                                <select id="memberCaste" class="w-full px-4 py-3 rounded-md bg-gray-800 text-white border border-gray-600 focus:border-blue-500 focus:outline-none" required>
                                    <option value="">Select Category</option>
                                    <option value="General">General / सामान्य</option>
                                    <option value="OBC">OBC / अन्य पिछड़ा वर्ग</option>
                                    <option value="SC">SC / अनुसूचित जाति</option>
                                    <option value="ST">ST / अनुसूचित जनजाति</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-white mb-2" data-en="Marital Status" data-hi="वैवाहिक स्थिति">Marital Status</label>
                                <select id="memberMaritalStatus" class="w-full px-4 py-3 rounded-md bg-gray-800 text-white border border-gray-600 focus:border-blue-500 focus:outline-none">
                                    <option value="">Select Status</option>
                                    <option value="Single">Single / अविवाहित</option>
                                    <option value="Married">Married / विवाहित</option>
                                    <option value="Divorced">Divorced / तलाकशुदा</option>
                                    <option value="Widowed">Widowed / विधवा/विधुर</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-white mb-2" data-en="Qualification" data-hi="योग्यता">Qualification</label>
                                <select id="memberQualification" class="w-full px-4 py-3 rounded-md bg-gray-800 text-white border border-gray-600 focus:border-blue-500 focus:outline-none">
                                    <option value="">Select Qualification</option>
                                    <option value="Illiterate">Illiterate / निरक्षर</option>
                                    <option value="Primary">Primary / प्राथमिक</option>
                                    <option value="Secondary">Secondary / माध्यमिक</option>
                                    <option value="Higher Secondary">Higher Secondary / उच्च माध्यमिक</option>
                                    <option value="Graduate">Graduate / स्नातक</option>
                                    <option value="Post Graduate">Post Graduate / स्नातकोत्तर</option>
                                    <option value="Professional">Professional / व्यावसायिक</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-white mb-2" data-en="Relationship" data-hi="रिश्ता">Relationship</label>
                                <select id="memberRelationship" class="w-full px-4 py-3 rounded-md bg-gray-800 text-white border border-gray-600 focus:border-blue-500 focus:outline-none">
                                    <option value="">Select Relationship</option>
                                    <option value="Head">Head / मुखिया</option>
                                    <option value="Spouse">Spouse / पति/पत्नी</option>
                                    <option value="Son">Son / पुत्र</option>
                                    <option value="Daughter">Daughter / पुत्री</option>
                                    <option value="Father">Father / पिता</option>
                                    <option value="Mother">Mother / माता</option>
                                    <option value="Brother">Brother / भाई</option>
                                    <option value="Sister">Sister / बहन</option>
                                    <option value="Other">Other / अन्य</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-white mb-2" data-en="Child Category" data-hi="बाल श्रेणी">Child Category</label>
                                <select id="memberChildCategory" class="w-full px-4 py-3 rounded-md bg-gray-800 text-white border border-gray-600 focus:border-blue-500 focus:outline-none">
                                    <option value="">Not Applicable</option>
                                    <option value="0-6m">0-6 months / 0-6 महीने</option>
                                    <option value="6m-3y">6 months - 3 years / 6 महीने - 3 साल</option>
                                    <option value="3-6y">3-6 years / 3-6 साल</option>
                                    <option value="Girls 11-19y">Girls 11-19 years / लड़कियां 11-19 साल</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-white mb-2" data-en="Deceased" data-hi="मृत">Deceased</label>
                                <select id="memberDeceased" class="w-full px-4 py-3 rounded-md bg-gray-800 text-white border border-gray-600 focus:border-blue-500 focus:outline-none">
                                    <option value="No">No / नहीं</option>
                                    <option value="Yes">Yes / हाँ</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-white mb-2" data-en="Aadhaar Made for Child" data-hi="बच्चे के लिए आधार बना">Aadhaar Made for Child</label>
                                <select id="memberAadhaarChild" class="w-full px-4 py-3 rounded-md bg-gray-800 text-white border border-gray-600 focus:border-blue-500 focus:outline-none">
                                    <option value="N/A">Not Applicable</option>
                                    <option value="Yes">Yes / हाँ</option>
                                    <option value="No">No / नहीं</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-white mb-2" data-en="Address" data-hi="पता">Address</label>
                            <div class="flex">
                                <textarea id="memberAddress" class="flex-1 px-4 py-3 rounded-l-md bg-gray-800 text-white border border-gray-600 focus:border-blue-500 focus:outline-none" rows="3" placeholder="Enter complete address"></textarea>
                                <button type="button" class="speech-btn rounded-r-md" data-field="memberAddress">
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-white mb-2" data-en="Notes" data-hi="टिप्पणियां">Notes</label>
                            <textarea id="memberNotes" class="w-full px-4 py-3 rounded-md bg-gray-800 text-white border border-gray-600 focus:border-blue-500 focus:outline-none" rows="3" placeholder="Additional notes"></textarea>
                        </div>
                        
                        <div id="deathCertificateSection" class="hidden">
                            <label class="block text-white mb-2" data-en="Death Certificate" data-hi="मृत्यु प्रमाण पत्र">Death Certificate</label>
                            <input type="file" id="deathCertificate" accept="image/*,application/pdf" class="w-full text-white bg-gray-800 border border-gray-600 rounded-lg p-2">
                        </div>
                        
                        <div class="flex justify-between items-center pt-6">
                            <div class="text-white">
                                <span data-en="Family ID:" data-hi="पारिवारिक आईडी:">Family ID:</span>
                                <span id="familyIdDisplay" class="font-mono text-blue-400">FAM-2024-01-001</span>
                            </div>
                            
                            <button type="submit" class="glass-button text-white px-8 py-3 rounded-lg font-semibold">
                                <i class="fas fa-save mr-2"></i><span data-en="Save Member" data-hi="सदस्य सेव करें">Save Member</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Family View Tab -->
            <div id="familyView" class="tab-content">
                <div class="glass-card p-6">
                    <h2 class="text-2xl font-bold text-white mb-6" data-en="Family View" data-hi="पारिवारिक दृश्य">Family View</h2>
                    
                    <div class="mb-6">
                        <div class="flex flex-wrap gap-4 mb-4">
                            <button id="listViewBtn" class="glass-button text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-list mr-2"></i><span data-en="List View" data-hi="सूची दृश्य">List View</span>
                            </button>
                            <button id="treeViewBtn" class="glass-button text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-sitemap mr-2"></i><span data-en="Tree View" data-hi="वृक्ष दृश्य">Tree View</span>
                            </button>
                            <select id="familyFilter" class="px-4 py-2 rounded-md bg-gray-800 text-white border border-gray-600">
                                <option value="">All Families</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="familyListView">
                        <div id="familyList" class="space-y-4">
                            <!-- Family cards will be populated here -->
                        </div>
                    </div>
                    
                    <div id="familyTreeView" class="hidden">
                        <div id="familyTree" class="family-tree">
                            <!-- Family tree will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content">
                <div class="space-y-6">
                    <div class="glass-card p-6">
                        <h2 class="text-2xl font-bold text-white mb-6" data-en="Survey Dashboard" data-hi="सर्वेक्षण डैशबोर्ड">Survey Dashboard</h2>
                        
                        <!-- Stats Cards -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="text-3xl font-bold text-blue-400 mb-2" id="totalPeople">0</div>
                                <div class="text-white" data-en="Total People Surveyed" data-hi="कुल सर्वेक्षण किए गए लोग">Total People Surveyed</div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="text-3xl font-bold text-green-400 mb-2" id="totalFamilies">0</div>
                                <div class="text-white" data-en="Total Families" data-hi="कुल परिवार">Total Families</div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="text-3xl font-bold text-yellow-400 mb-2" id="aadhaarMissing">0</div>
                                <div class="text-white" data-en="Aadhaar Missing" data-hi="आधार अनुपस्थित">Aadhaar Missing</div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="text-3xl font-bold text-red-400 mb-2" id="deceasedCount">0</div>
                                <div class="text-white" data-en="Deceased" data-hi="मृत">Deceased</div>
                            </div>
                        </div>
                        
                        <!-- Filters -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-white mb-4" data-en="Filters" data-hi="फ़िल्टर">Filters</h3>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <select id="filterCaste" class="px-4 py-2 rounded-md bg-gray-800 text-white border border-gray-600">
                                    <option value="">All Castes</option>
                                    <option value="General">General</option>
                                    <option value="OBC">OBC</option>
                                    <option value="SC">SC</option>
                                    <option value="ST">ST</option>
                                </select>
                                
                                <select id="filterGender" class="px-4 py-2 rounded-md bg-gray-800 text-white border border-gray-600">
                                    <option value="">All Genders</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                                
                                <select id="filterAadhaar" class="px-4 py-2 rounded-md bg-gray-800 text-white border border-gray-600">
                                    <option value="">Aadhaar Status</option>
                                    <option value="present">Has Aadhaar</option>
                                    <option value="missing">Missing Aadhaar</option>
                                </select>
                                
                                <select id="filterChildCategory" class="px-4 py-2 rounded-md bg-gray-800 text-white border border-gray-600">
                                    <option value="">All Ages</option>
                                    <option value="0-6m">0-6 months</option>
                                    <option value="6m-3y">6m-3y</option>
                                    <option value="3-6y">3-6y</option>
                                    <option value="Girls 11-19y">Girls 11-19y</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Charts -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="glass-card p-4">
                                <h3 class="text-lg font-semibold text-white mb-4" data-en="Gender Distribution" data-hi="लिंग वितरण">Gender Distribution</h3>
                                <canvas id="genderChart" style="height: 300px;"></canvas>
                            </div>
                            
                            <div class="glass-card p-4">
                                <h3 class="text-lg font-semibold text-white mb-4" data-en="Caste Distribution" data-hi="जाति वितरण">Caste Distribution</h3>
                                <canvas id="casteChart" style="height: 300px;"></canvas>
                            </div>
                            
                            <div class="glass-card p-4">
                                <h3 class="text-lg font-semibold text-white mb-4" data-en="Age Groups" data-hi="आयु समूह">Age Groups</h3>
                                <canvas id="ageChart" style="height: 300px;"></canvas>
                            </div>
                            
                            <div class="glass-card p-4">
                                <h3 class="text-lg font-semibold text-white mb-4" data-en="Child Categories" data-hi="बाल श्रेणियां">Child Categories</h3>
                                <canvas id="childChart" style="height: 300px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Export/Import Tab -->
            <div id="exportImport" class="tab-content">
                <div class="glass-card p-6">
                    <h2 class="text-2xl font-bold text-white mb-6" data-en="Export / Import Data" data-hi="डेटा निर्यात / आयात">Export / Import Data</h2>
                    
                    <!-- Export Section -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-white mb-4" data-en="Export Data" data-hi="डेटा निर्यात">Export Data</h3>
                        
                        <div class="space-y-4">
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center text-white">
                                    <input type="checkbox" id="maskAadhaar" class="mr-2">
                                    <span data-en="Mask Aadhaar Numbers" data-hi="आधार संख्या छुपाएं">Mask Aadhaar Numbers</span>
                                </label>
                                
                                <label class="flex items-center text-white">
                                    <input type="checkbox" id="exportSelected" class="mr-2">
                                    <span data-en="Export Selected Only" data-hi="केवल चयनित निर्यात करें">Export Selected Only</span>
                                </label>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <button id="exportExcel" class="glass-button text-white px-6 py-3 rounded-lg font-semibold">
                                    <i class="fas fa-file-excel mr-2"></i><span data-en="Export to Excel" data-hi="एक्सेल में निर्यात">Export to Excel</span>
                                </button>
                                
                                <button id="exportJson" class="glass-button text-white px-6 py-3 rounded-lg font-semibold">
                                    <i class="fas fa-file-code mr-2"></i><span data-en="Export to JSON" data-hi="JSON में निर्यात">Export to JSON</span>
                                </button>
                                
                                <button id="exportPdf" class="glass-button text-white px-6 py-3 rounded-lg font-semibold">
                                    <i class="fas fa-file-pdf mr-2"></i><span data-en="Export to PDF" data-hi="PDF में निर्यात">Export to PDF</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Import Section -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-white mb-4" data-en="Import Data" data-hi="डेटा आयात">Import Data</h3>
                        
                        <div class="space-y-4">
                            <input type="file" id="importFile" accept=".json" class="w-full text-white bg-gray-800 border border-gray-600 rounded-lg p-3">
                            
                            <button id="importData" class="glass-button text-white px-6 py-3 rounded-lg font-semibold">
                                <i class="fas fa-upload mr-2"></i><span data-en="Import JSON Backup" data-hi="JSON बैकअप आयात करें">Import JSON Backup</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Data Selection -->
                    <div id="dataSelection">
                        <h3 class="text-lg font-semibold text-white mb-4" data-en="Select Records for Export" data-hi="निर्यात के लिए रिकॉर्ड चुनें">Select Records for Export</h3>
                        
                        <div class="space-y-2 max-h-96 overflow-y-auto">
                            <div class="flex items-center mb-4">
                                <input type="checkbox" id="selectAll" class="mr-2">
                                <label for="selectAll" class="text-white font-semibold" data-en="Select All" data-hi="सभी चुनें">Select All</label>
                            </div>
                            
                            <div id="recordList" class="space-y-2">
                                <!-- Records will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <div class="glass-card p-6">
                    <h2 class="text-2xl font-bold text-white mb-6" data-en="Settings" data-hi="सेटिंग्स">Settings</h2>
                    
                    <div class="space-y-6">
                        <!-- Language Settings -->
                        <div>
                            <h3 class="text-lg font-semibold text-white mb-4" data-en="Language" data-hi="भाषा">Language</h3>
                            <div class="flex space-x-4">
                                <label class="flex items-center text-white">
                                    <input type="radio" name="language" value="en" class="mr-2" checked>
                                    <span>English</span>
                                </label>
                                <label class="flex items-center text-white">
                                    <input type="radio" name="language" value="hi" class="mr-2">
                                    <span>हिंदी</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Theme Settings -->
                        <div>
                            <h3 class="text-lg font-semibold text-white mb-4" data-en="Theme" data-hi="थीम">Theme</h3>
                            <div class="flex space-x-4">
                                <label class="flex items-center text-white">
                                    <input type="radio" name="theme" value="light" class="mr-2">
                                    <span data-en="Light Mode" data-hi="लाइट मोड">Light Mode</span>
                                </label>
                                <label class="flex items-center text-white">
                                    <input type="radio" name="theme" value="dark" class="mr-2" checked>
                                    <span data-en="Dark Mode" data-hi="डार्क मोड">Dark Mode</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Feature Toggles -->
                        <div>
                            <h3 class="text-lg font-semibold text-white mb-4" data-en="Features" data-hi="सुविधाएं">Features</h3>
                            <div class="space-y-3">
                                <label class="flex items-center text-white">
                                    <input type="checkbox" id="enableOcr" class="mr-2" checked>
                                    <span data-en="Enable OCR" data-hi="OCR सक्षम करें">Enable OCR</span>
                                </label>
                                
                                <label class="flex items-center text-white">
                                    <input type="checkbox" id="enableCamera" class="mr-2" checked>
                                    <span data-en="Enable Camera Access" data-hi="कैमरा एक्सेस सक्षम करें">Enable Camera Access</span>
                                </label>
                                
                                <label class="flex items-center text-white">
                                    <input type="checkbox" id="enableSpeech" class="mr-2" checked>
                                    <span data-en="Enable Speech-to-Text" data-hi="स्पीच-टू-टेक्स्ट सक्षम करें">Enable Speech-to-Text</span>
                                </label>
                                
                                <label class="flex items-center text-white">
                                    <input type="checkbox" id="preventScreenshot" class="mr-2">
                                    <span data-en="Prevent Screenshots" data-hi="स्क्रीनशॉट रोकें">Prevent Screenshots</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Storage Info -->
                        <div>
                            <h3 class="text-lg font-semibold text-white mb-4" data-en="Storage Information" data-hi="भंडारण जानकारी">Storage Information</h3>
                            <div class="glass-card p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-white" data-en="Used Storage:" data-hi="उपयोग किया गया भंडारण:">Used Storage:</span>
                                    <span id="usedStorage" class="text-blue-400">0 MB</span>
                                </div>
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-white" data-en="Available Storage:" data-hi="उपलब्ध भंडारण:">Available Storage:</span>
                                    <span class="text-green-400">~10 GB</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-white" data-en="Total Records:" data-hi="कुल रिकॉर्ड:">Total Records:</span>
                                    <span id="totalRecords" class="text-yellow-400">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Security Settings -->
                        <div>
                            <h3 class="text-lg font-semibold text-white mb-4" data-en="Security" data-hi="सुरक्षा">Security</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-white mb-2" data-en="Admin PIN" data-hi="एडमिन पिन">Admin PIN</label>
                                    <input type="password" id="adminPin" class="w-full px-4 py-3 rounded-md bg-gray-800 text-white border border-gray-600 focus:border-blue-500 focus:outline-none" placeholder="Enter 4-digit PIN" maxlength="4">
                                </div>
                                
                                <button id="clearAllData" class="glass-button bg-red-600 text-white px-6 py-3 rounded-lg font-semibold">
                                    <i class="fas fa-trash mr-2"></i><span data-en="Clear All Data" data-hi="सभी डेटा साफ़ करें">Clear All Data</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Floating Action Button -->
        <button id="floatingBtn" class="floating-btn glass-button p-4 rounded-full text-white">
            <i class="fas fa-plus text-xl"></i>
        </button>
        
        <!-- PWA Install Button -->
        <div id="pwaInstall" class="pwa-install glass-card p-3 text-white hidden">
            <button id="installBtn" class="flex items-center">
                <i class="fas fa-download mr-2"></i>
                <span data-en="Install App" data-hi="ऐप इंस्टॉल करें">Install App</span>
            </button>
        </div>
    </div>
    
    <!-- Camera Modal -->
    <div id="cameraModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="glass-card p-6 max-w-2xl w-full mx-4">
            <h3 class="text-xl font-bold text-white mb-4" data-en="Capture Photo" data-hi="फोटो खींचें">Capture Photo</h3>
            
            <video id="cameraVideo" class="w-full mb-4 rounded-lg" autoplay playsinline></video>
            <canvas id="cameraCanvas" class="hidden"></canvas>
            
            <div class="flex justify-between">
                <button id="captureBtn" class="glass-button text-white px-6 py-3 rounded-lg">
                    <i class="fas fa-camera mr-2"></i><span data-en="Capture" data-hi="कैप्चर">Capture</span>
                </button>
                
                <button id="closeCameraBtn" class="glass-button text-white px-6 py-3 rounded-lg">
                    <i class="fas fa-times mr-2"></i><span data-en="Close" data-hi="बंद करें">Close</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Crop Modal -->
    <div id="cropModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="glass-card p-6 max-w-4xl w-full mx-4">
            <h3 class="text-xl font-bold text-white mb-4" data-en="Crop & Rotate Image" data-hi="इमेज क्रॉप और घुमाएं">Crop & Rotate Image</h3>
            
            <div class="mb-4">
                <img id="cropImage" class="max-w-full" alt="Crop Image">
            </div>
            
            <div class="flex justify-between">
                <div class="space-x-2">
                    <button id="rotateLeft" class="glass-button text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-undo mr-2"></i><span data-en="Rotate Left" data-hi="बाएं घुमाएं">Rotate Left</span>
                    </button>
                    
                    <button id="rotateRight" class="glass-button text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-redo mr-2"></i><span data-en="Rotate Right" data-hi="दाएं घुमाएं">Rotate Right</span>
                    </button>
                </div>
                
                <div class="space-x-2">
                    <button id="cropConfirm" class="glass-button text-white px-6 py-3 rounded-lg">
                        <i class="fas fa-check mr-2"></i><span data-en="Confirm" data-hi="पुष्टि करें">Confirm</span>
                    </button>
                    
                    <button id="cropCancel" class="glass-button text-white px-6 py-3 rounded-lg">
                        <i class="fas fa-times mr-2"></i><span data-en="Cancel" data-hi="रद्द करें">Cancel</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
  apiKey: "AIzaSyCVkUtqfDKUvLjx3h4WPqx--OtuxYq4mUg",
  authDomain: "aadhaar-survey.firebaseapp.com",
  projectId: "aadhaar-survey",
  storageBucket: "aadhaar-survey.firebasestorage.app",
  messagingSenderId: "212472561980",
  appId: "1:212472561980:web:bbfd807e657981de7f9e39"
};

        // Initialize Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getAuth, RecaptchaVerifier, signInWithPhoneNumber, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Global Variables
        let currentUser = null;
        let confirmationResult = null;
        let cropper = null;
        let currentCamera = null;
        let currentCameraType = null;
        let recognition = null;
        let currentSpeechField = null;
        let charts = {};
        let deferredPrompt = null;

        // IndexedDB Configuration
        const dbName = 'AadhaarSurveyDB';
        const dbVersion = 1;
        let db = null;

        // Initialize IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, dbVersion);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Create members store
                    if (!db.objectStoreNames.contains('members')) {
                        const membersStore = db.createObjectStore('members', { keyPath: 'id', autoIncrement: true });
                        membersStore.createIndex('aadhaar', 'aadhaar', { unique: true });
                        membersStore.createIndex('familyId', 'familyId', { unique: false });
                        membersStore.createIndex('name', 'name', { unique: false });
                    }
                    
                    // Create settings store
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'key' });
                    }
                };
            });
        }

        // Database operations
        function addMember(memberData) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['members'], 'readwrite');
                const store = transaction.objectStore('members');
                
                memberData.timestamp = new Date().toISOString();
                const request = store.add(memberData);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function getAllMembers() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['members'], 'readonly');
                const store = transaction.objectStore('members');
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function updateMember(id, memberData) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['members'], 'readwrite');
                const store = transaction.objectStore('members');
                
                memberData.id = id;
                memberData.updatedAt = new Date().toISOString();
                const request = store.put(memberData);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function deleteMember(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['members'], 'readwrite');
                const store = transaction.objectStore('members');
                const request = store.delete(id);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function checkAadhaarExists(aadhaar) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['members'], 'readonly');
                const store = transaction.objectStore('members');
                const index = store.index('aadhaar');
                const request = index.get(aadhaar);
                
                request.onsuccess = () => resolve(request.result ? true : false);
                request.onerror = () => reject(request.error);
            });
        }

        // Firebase Authentication
        function initializeRecaptcha() {
            if (!window.recaptchaVerifier) {
                window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
                    'size': 'normal',
                    'callback': (response) => {
                        console.log('reCAPTCHA solved');
                    },
                    'expired-callback': () => {
                        console.log('reCAPTCHA expired');
                    }
                });
            }
        }

        // UI Functions
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toastIcon');
            const toastMessage = document.getElementById('toastMessage');
            
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            
            toastIcon.className = icons[type] || icons.info;
            toastMessage.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function showLoading(message = 'Loading...') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            loadingText.textContent = message;
            overlay.classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab button
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('bg-blue-600');
            
            // Load tab-specific data
            if (tabName === 'dashboard') {
                loadDashboard();
            } else if (tabName === 'familyView') {
                loadFamilyView();
            } else if (tabName === 'exportImport') {
                loadExportImport();
            } else if (tabName === 'settings') {
                loadSettings();
            }
        }

        // Generate Family ID
        function generateFamilyId() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `FAM-${year}-${month}-${random}`;
        }

        // Validate Aadhaar Number
        function validateAadhaar(aadhaar) {
            const cleanAadhaar = aadhaar.replace(/\s/g, '');
            return /^\d{12}$/.test(cleanAadhaar);
        }

        // Format Aadhaar Number
        function formatAadhaar(aadhaar) {
            const clean = aadhaar.replace(/\s/g, '');
            return clean.replace(/(\d{4})(\d{4})(\d{4})/, '$1 $2 $3');
        }

        // Calculate Age
        function calculateAge(dob) {
            const today = new Date();
            const birthDate = new Date(dob);
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            return age;
        }

        // Camera Functions
        function startCamera(type) {
            currentCameraType = type;
            const modal = document.getElementById('cameraModal');
            const video = document.getElementById('cameraVideo');
            
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            })
            .then(stream => {
                currentCamera = stream;
                video.srcObject = stream;
                modal.classList.remove('hidden');
            })
            .catch(error => {
                showToast('Camera access denied or not available', 'error');
                console.error('Camera error:', error);
            });
        }

        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            const dataURL = canvas.toDataURL('image/jpeg', 0.8);
            
            if (currentCameraType === 'front') {
                document.getElementById('frontImage').src = dataURL;
                document.getElementById('frontPreview').classList.remove('hidden');
            } else {
                document.getElementById('backImage').src = dataURL;
                document.getElementById('backPreview').classList.remove('hidden');
            }
            
            closeCamera();
        }

        function closeCamera() {
            if (currentCamera) {
                currentCamera.getTracks().forEach(track => track.stop());
                currentCamera = null;
            }
            document.getElementById('cameraModal').classList.add('hidden');
        }

        // Cropper Functions
        function initCropper(imageElement) {
            const modal = document.getElementById('cropModal');
            const cropImage = document.getElementById('cropImage');
            
            cropImage.src = imageElement.src;
            modal.classList.remove('hidden');
            
            setTimeout(() => {
                if (cropper) {
                    cropper.destroy();
                }
                
                cropper = new Cropper(cropImage, {
                    aspectRatio: 1.586, // Aadhaar card aspect ratio
                    viewMode: 1,
                    dragMode: 'move',
                    autoCropArea: 1,
                    restore: false,
                    guides: true,
                    center: true,
                    highlight: false,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    toggleDragModeOnDblclick: false
                });
            }, 100);
        }

        function rotateCropper(degree) {
            if (cropper) {
                cropper.rotate(degree);
            }
        }

        function confirmCrop() {
            if (cropper) {
                const canvas = cropper.getCroppedCanvas({
                    width: 800,
                    height: 504,
                    imageSmoothingEnabled: true,
                    imageSmoothingQuality: 'high'
                });
                
                const dataURL = canvas.toDataURL('image/jpeg', 0.9);
                
                if (currentCameraType === 'front') {
                    document.getElementById('frontImage').src = dataURL;
                } else {
                    document.getElementById('backImage').src = dataURL;
                }
                
                closeCropModal();
            }
        }

        function closeCropModal() {
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            document.getElementById('cropModal').classList.add('hidden');
        }

        // OCR Functions
        async function extractAadhaarData() {
            const frontImg = document.getElementById('frontImage');
            const backImg = document.getElementById('backImage');
            
            if (!frontImg.src || frontImg.src === window.location.href) {
                showToast('Please upload Aadhaar front image first', 'warning');
                return;
            }
            
            showLoading('Extracting data from Aadhaar card...');
            
            try {
                // Extract from front side
                const frontResult = await Tesseract.recognize(frontImg.src, 'eng+hin', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            showLoading(`Processing: ${Math.round(m.progress * 100)}%`);
                        }
                    }
                });
                
                const frontText = frontResult.data.text;
                console.log('Front OCR Text:', frontText);
                
                // Extract back side if available
                let backText = '';
                if (backImg.src && backImg.src !== window.location.href) {
                    const backResult = await Tesseract.recognize(backImg.src, 'eng+hin');
                    backText = backResult.data.text;
                    console.log('Back OCR Text:', backText);
                }
                
                // Parse extracted data
                const extractedData = parseAadhaarText(frontText, backText);
                
                // Auto-fill form
                if (extractedData.name) {
                    document.getElementById('memberName').value = extractedData.name;
                }
                if (extractedData.dob) {
                    document.getElementById('memberDob').value = extractedData.dob;
                }
                if (extractedData.aadhaar) {
                    document.getElementById('memberAadhaar').value = formatAadhaar(extractedData.aadhaar);
                }
                if (extractedData.gender) {
                    document.getElementById('memberGender').value = extractedData.gender;
                }
                if (extractedData.address) {
                    document.getElementById('memberAddress').value = extractedData.address;
                }
                
                hideLoading();
                showToast('Data extracted successfully! Please verify and correct if needed.', 'success');
                
                // Check OCR confidence
                if (frontResult.data.confidence < 60) {
                    showToast('Image quality seems low. Please verify extracted data carefully.', 'warning');
                }
                
            } catch (error) {
                hideLoading();
                showToast('Failed to extract data. Please enter manually.', 'error');
                console.error('OCR Error:', error);
            }
        }

        function parseAadhaarText(frontText, backText) {
            const data = {};
            const fullText = frontText + ' ' + backText;
            
            // Extract Aadhaar number (12 digits)
            const aadhaarMatch = fullText.match(/(\d{4}\s*\d{4}\s*\d{4})/);
            if (aadhaarMatch) {
                data.aadhaar = aadhaarMatch[1].replace(/\s/g, '');
            }
            
            // Extract DOB (various formats)
            const dobPatterns = [
                /DOB[:\s]*(\d{2}\/\d{2}\/\d{4})/i,
                /(\d{2}\/\d{2}\/\d{4})/,
                /(\d{2}-\d{2}-\d{4})/,
                /(\d{4}-\d{2}-\d{2})/
            ];
            
            for (const pattern of dobPatterns) {
                const match = fullText.match(pattern);
                if (match) {
                    let dob = match[1];
                    // Convert to YYYY-MM-DD format
                    if (dob.includes('/')) {
                        const parts = dob.split('/');
                        if (parts[2].length === 4) {
                            dob = `${parts[2]}-${parts[1]}-${parts[0]}`;
                        }
                    }
                    data.dob = dob;
                    break;
                }
            }
            
            // Extract Gender
            if (/male/i.test(fullText) && !/female/i.test(fullText)) {
                data.gender = 'Male';
            } else if (/female/i.test(fullText)) {
                data.gender = 'Female';
            }
            
            // Extract Name (heuristic approach)
            const lines = frontText.split('\n').filter(line => line.trim().length > 2);
            for (const line of lines) {
                const trimmed = line.trim();
                // Skip lines with numbers, dates, or common Aadhaar keywords
                if (!/\d{4}|\d{2}\/\d{2}\/\d{4}|DOB|MALE|FEMALE|GOVERNMENT|INDIA|AADHAAR/i.test(trimmed) && 
                    trimmed.length > 5 && trimmed.length < 50) {
                    data.name = trimmed;
                    break;
                }
            }
            
            // Extract Address (from back side or combined text)
            const addressLines = backText.split('\n').filter(line => 
                line.trim().length > 10 && 
                !/\d{12}|AADHAAR|GOVERNMENT|INDIA/i.test(line)
            );
            
            if (addressLines.length > 0) {
                data.address = addressLines.slice(0, 3).join(', ').trim();
            }
            
            return data;
        }

        // Speech Recognition
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = document.querySelector('input[name="language"]:checked').value === 'hi' ? 'hi-IN' : 'en-IN';
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    if (currentSpeechField) {
                        const field = document.getElementById(currentSpeechField);
                        field.value = transcript;
                        currentSpeechField = null;
                    }
                };
                
                recognition.onerror = function(event) {
                    showToast('Speech recognition error: ' + event.error, 'error');
                    stopSpeechRecognition();
                };
                
                recognition.onend = function() {
                    stopSpeechRecognition();
                };
            }
        }

        function startSpeechRecognition(fieldId) {
            if (!recognition) {
                showToast('Speech recognition not supported', 'error');
                return;
            }
            
            currentSpeechField = fieldId;
            const button = document.querySelector(`[data-field="${fieldId}"]`);
            button.classList.add('recording');
            
            try {
                recognition.start();
                showToast('Listening... Speak now', 'info');
            } catch (error) {
                showToast('Failed to start speech recognition', 'error');
                stopSpeechRecognition();
            }
        }

        function stopSpeechRecognition() {
            document.querySelectorAll('.speech-btn').forEach(btn => {
                btn.classList.remove('recording');
            });
            currentSpeechField = null;
        }

        // Dashboard Functions
        async function loadDashboard() {
            try {
                const members = await getAllMembers();
                updateDashboardStats(members);
                updateCharts(members);
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        function updateDashboardStats(members) {
            const totalPeople = members.length;
            const families = [...new Set(members.map(m => m.familyId))];
            const totalFamilies = families.length;
            const aadhaarMissing = members.filter(m => !m.aadhaar || m.aadhaar.length < 12).length;
            const deceasedCount = members.filter(m => m.deceased === 'Yes').length;
            
            document.getElementById('totalPeople').textContent = totalPeople;
            document.getElementById('totalFamilies').textContent = totalFamilies;
            document.getElementById('aadhaarMissing').textContent = aadhaarMissing;
            document.getElementById('deceasedCount').textContent = deceasedCount;
        }

        function updateCharts(members) {
            // Apply filters
            let filteredMembers = members;
            
            const filterCaste = document.getElementById('filterCaste').value;
            const filterGender = document.getElementById('filterGender').value;
            const filterAadhaar = document.getElementById('filterAadhaar').value;
            const filterChildCategory = document.getElementById('filterChildCategory').value;
            
            if (filterCaste) {
                filteredMembers = filteredMembers.filter(m => m.caste === filterCaste);
            }
            if (filterGender) {
                filteredMembers = filteredMembers.filter(m => m.gender === filterGender);
            }
            if (filterAadhaar === 'present') {
                filteredMembers = filteredMembers.filter(m => m.aadhaar && m.aadhaar.length >= 12);
            } else if (filterAadhaar === 'missing') {
                filteredMembers = filteredMembers.filter(m => !m.aadhaar || m.aadhaar.length < 12);
            }
            if (filterChildCategory) {
                filteredMembers = filteredMembers.filter(m => m.childCategory === filterChildCategory);
            }
            
            // Gender Chart
            const genderData = {
                Male: filteredMembers.filter(m => m.gender === 'Male').length,
                Female: filteredMembers.filter(m => m.gender === 'Female').length,
                Other: filteredMembers.filter(m => m.gender === 'Other').length
            };
            
            updateChart('genderChart', 'Gender Distribution', genderData, 'doughnut');
            
            // Caste Chart
            const casteData = {
                General: filteredMembers.filter(m => m.caste === 'General').length,
                OBC: filteredMembers.filter(m => m.caste === 'OBC').length,
                SC: filteredMembers.filter(m => m.caste === 'SC').length,
                ST: filteredMembers.filter(m => m.caste === 'ST').length
            };
            
            updateChart('casteChart', 'Caste Distribution', casteData, 'pie');
            
            // Age Chart
            const ageGroups = {
                '0-18': 0,
                '19-35': 0,
                '36-50': 0,
                '51-65': 0,
                '65+': 0
            };
            
            filteredMembers.forEach(member => {
                if (member.dob) {
                    const age = calculateAge(member.dob);
                    if (age <= 18) ageGroups['0-18']++;
                    else if (age <= 35) ageGroups['19-35']++;
                    else if (age <= 50) ageGroups['36-50']++;
                    else if (age <= 65) ageGroups['51-65']++;
                    else ageGroups['65+']++;
                }
            });
            
            updateChart('ageChart', 'Age Groups', ageGroups, 'bar');
            
            // Child Categories Chart
            const childData = {
                '0-6m': filteredMembers.filter(m => m.childCategory === '0-6m').length,
                '6m-3y': filteredMembers.filter(m => m.childCategory === '6m-3y').length,
                '3-6y': filteredMembers.filter(m => m.childCategory === '3-6y').length,
                'Girls 11-19y': filteredMembers.filter(m => m.childCategory === 'Girls 11-19y').length
            };
            
            updateChart('childChart', 'Child Categories', childData, 'doughnut');
        }

        function updateChart(canvasId, title, data, type) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }
            
            const colors = [
                '#3b82f6', '#10b981', '#f59e0b', '#ef4444',
                '#8b5cf6', '#06b6d4', '#84cc16', '#f97316'
            ];
            
            charts[canvasId] = new Chart(ctx, {
                type: type,
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: colors,
                        borderColor: colors.map(color => color + '80'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: title,
                            color: '#fff'
                        },
                        legend: {
                            labels: {
                                color: '#fff'
                            }
                        }
                    },
                    scales: type === 'bar' ? {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#fff'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#fff'
                            }
                        }
                    } : {}
                }
            });
        }

        // Family View Functions
        async function loadFamilyView() {
            try {
                const members = await getAllMembers();
                updateFamilyFilter(members);
                displayFamilyList(members);
            } catch (error) {
                console.error('Error loading family view:', error);
            }
        }

        function updateFamilyFilter(members) {
            const families = [...new Set(members.map(m => m.familyId))];
            const select = document.getElementById('familyFilter');
            
            select.innerHTML = '<option value="">All Families</option>';
            families.forEach(familyId => {
                const option = document.createElement('option');
                option.value = familyId;
                option.textContent = familyId;
                select.appendChild(option);
            });
        }

        function displayFamilyList(members) {
            const container = document.getElementById('familyList');
            const families = groupByFamily(members);
            
            container.innerHTML = '';
            
            Object.keys(families).forEach(familyId => {
                const familyCard = createFamilyCard(familyId, families[familyId]);
                container.appendChild(familyCard);
            });
        }

        function groupByFamily(members) {
            const families = {};
            members.forEach(member => {
                if (!families[member.familyId]) {
                    families[member.familyId] = [];
                }
                families[member.familyId].push(member);
            });
            return families;
        }

        function createFamilyCard(familyId, members) {
            const card = document.createElement('div');
            card.className = 'glass-card p-6';
            
            card.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-white">${familyId}</h3>
                    <span class="bg-blue-600 text-white px-3 py-1 rounded-full text-sm">${members.length} members</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${members.map(member => `
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-semibold text-white">${member.name || 'Unknown'}</h4>
                                <div class="flex space-x-2">
                                    <button onclick="editMember(${member.id})" class="text-blue-400 hover:text-blue-300">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteMemberConfirm(${member.id})" class="text-red-400 hover:text-red-300">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="text-sm text-gray-300 space-y-1">
                                <div><strong>Age:</strong> ${member.dob ? calculateAge(member.dob) : 'N/A'}</div>
                                <div><strong>Gender:</strong> ${member.gender || 'N/A'}</div>
                                <div><strong>Relation:</strong> ${member.relationship || 'N/A'}</div>
                                <div><strong>Aadhaar:</strong> ${member.aadhaar ? '****-****-' + member.aadhaar.slice(-4) : 'Missing'}</div>
                                <div><strong>Caste:</strong> ${member.caste || 'N/A'}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="mt-4 text-center">
                    <button onclick="addFamilyMember('${familyId}')" class="glass-button text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-user-plus mr-2"></i>Add Member
                    </button>
                </div>
            `;
            
            return card;
        }

        function displayFamilyTree(members) {
            const container = document.getElementById('familyTree');
            const families = groupByFamily(members);
            
            container.innerHTML = '';
            
            Object.keys(families).forEach(familyId => {
                const treeDiv = document.createElement('div');
                treeDiv.className = 'mb-8';
                
                const familyMembers = families[familyId];
                const head = familyMembers.find(m => m.relationship === 'Head');
                const spouse = familyMembers.find(m => m.relationship === 'Spouse');
                const children = familyMembers.filter(m => ['Son', 'Daughter'].includes(m.relationship));
                const others = familyMembers.filter(m => !['Head', 'Spouse', 'Son', 'Daughter'].includes(m.relationship));
                
                treeDiv.innerHTML = `
                    <h3 class="text-xl font-bold text-white mb-4 text-center">${familyId}</h3>
                    
                    <div class="family-tree">
                        ${head ? `<div class="family-member bg-blue-600">${head.name}<br/><small>${head.relationship}</small></div>` : ''}
                        ${spouse ? `<div class="family-member bg-pink-600">${spouse.name}<br/><small>${spouse.relationship}</small></div>` : ''}
                        
                        ${children.length > 0 ? `
                            <div class="flex justify-center flex-wrap mt-4">
                                ${children.map(child => `
                                    <div class="family-member bg-green-600 m-2">${child.name}<br/><small>${child.relationship}</small></div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${others.length > 0 ? `
                            <div class="flex justify-center flex-wrap mt-4">
                                ${others.map(other => `
                                    <div class="family-member bg-gray-600 m-2">${other.name}<br/><small>${other.relationship}</small></div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
                
                container.appendChild(treeDiv);
            });
        }

        // Export/Import Functions
        async function loadExportImport() {
            try {
                const members = await getAllMembers();
                displayRecordList(members);
            } catch (error) {
                console.error('Error loading export/import:', error);
            }
        }

        function displayRecordList(members) {
            const container = document.getElementById('recordList');
            container.innerHTML = '';
            
            members.forEach(member => {
                const div = document.createElement('div');
                div.className = 'flex items-center p-2 bg-gray-800 rounded-lg';
                div.innerHTML = `
                    <input type="checkbox" class="record-checkbox mr-3" value="${member.id}">
                    <div class="flex-1">
                        <div class="text-white font-medium">${member.name || 'Unknown'}</div>
                        <div class="text-gray-400 text-sm">${member.familyId} - ${member.aadhaar ? '****-****-' + member.aadhaar.slice(-4) : 'No Aadhaar'}</div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function exportToExcel() {
            try {
                const members = await getAllMembers();
                const selectedMembers = getSelectedMembers(members);
                const maskAadhaar = document.getElementById('maskAadhaar').checked;
                
                const exportData = selectedMembers.map(member => {
                    const data = {
                        'Family ID': member.familyId,
                        'Name': member.name,
                        'Date of Birth': member.dob,
                        'Age': member.dob ? calculateAge(member.dob) : '',
                        'Gender': member.gender,
                        'Aadhaar Number': maskAadhaar && member.aadhaar ? 
                            '****-****-' + member.aadhaar.slice(-4) : member.aadhaar,
                        'Mobile Number': member.mobile,
                        'Caste': member.caste,
                        'Marital Status': member.maritalStatus,
                        'Qualification': member.qualification,
                        'Relationship': member.relationship,
                        'Child Category': member.childCategory,
                        'Deceased': member.deceased,
                        'Aadhaar for Child': member.aadhaarChild,
                        'Address': member.address,
                        'Notes': member.notes,
                        'Created Date': member.timestamp
                    };
                    
                    return data;
                });
                
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(exportData);
                
                // Auto-size columns
                const colWidths = Object.keys(exportData[0] || {}).map(key => ({
                    wch: Math.max(key.length, 15)
                }));
                ws['!cols'] = colWidths;
                
                XLSX.utils.book_append_sheet(wb, ws, 'Aadhaar Survey Data');
                
                const fileName = `aadhaar_survey_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showToast('Excel file downloaded successfully', 'success');
            } catch (error) {
                showToast('Failed to export Excel file', 'error');
                console.error('Export error:', error);
            }
        }

        async function exportToJson() {
            try {
                const members = await getAllMembers();
                const selectedMembers = getSelectedMembers(members);
                const maskAadhaar = document.getElementById('maskAadhaar').checked;
                
                const exportData = selectedMembers.map(member => {
                    const data = { ...member };
                    if (maskAadhaar && data.aadhaar) {
                        data.aadhaar = '****-****-' + data.aadhaar.slice(-4);
                    }
                    return data;
                });
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `aadhaar_survey_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showToast('JSON backup downloaded successfully', 'success');
            } catch (error) {
                showToast('Failed to export JSON file', 'error');
                console.error('Export error:', error);
            }
        }

        function getSelectedMembers(members) {
            const exportSelected = document.getElementById('exportSelected').checked;
            
            if (!exportSelected) {
                return members;
            }
            
            const selectedIds = Array.from(document.querySelectorAll('.record-checkbox:checked'))
                .map(cb => parseInt(cb.value));
            
            return members.filter(member => selectedIds.includes(member.id));
        }

        async function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showToast('Please select a JSON file to import', 'warning');
                return;
            }
            
            try {
                const text = await file.text();
                const importedData = JSON.parse(text);
                
                if (!Array.isArray(importedData)) {
                    throw new Error('Invalid file format');
                }
                
                showLoading('Importing data...');
                
                let imported = 0;
                let skipped = 0;
                
                for (const memberData of importedData) {
                    try {
                        // Check for duplicate Aadhaar
                        if (memberData.aadhaar && await checkAadhaarExists(memberData.aadhaar)) {
                            skipped++;
                            continue;
                        }
                        
                        // Remove ID to let IndexedDB auto-generate
                        delete memberData.id;
                        
                        await addMember(memberData);
                        imported++;
                    } catch (error) {
                        console.error('Failed to import member:', error);
                        skipped++;
                    }
                }
                
                hideLoading();
                showToast(`Import completed: ${imported} imported, ${skipped} skipped`, 'success');
                
                // Refresh current view
                if (document.getElementById('dashboard').classList.contains('active')) {
                    loadDashboard();
                } else if (document.getElementById('familyView').classList.contains('active')) {
                    loadFamilyView();
                }
                
            } catch (error) {
                hideLoading();
                showToast('Failed to import data. Please check file format.', 'error');
                console.error('Import error:', error);
            }
        }

        // Settings Functions
        function loadSettings() {
            updateStorageInfo();
        }

        async function updateStorageInfo() {
            try {
                if ('storage' in navigator && 'estimate' in navigator.storage) {
                    const estimate = await navigator.storage.estimate();
                    const usedMB = (estimate.usage / 1024 / 1024).toFixed(2);
                    document.getElementById('usedStorage').textContent = `${usedMB} MB`;
                }
                
                const members = await getAllMembers();
                document.getElementById('totalRecords').textContent = members.length;
            } catch (error) {
                console.error('Error getting storage info:', error);
            }
        }

        function changeLanguage(lang) {
            document.querySelectorAll('[data-en]').forEach(element => {
                const text = element.getAttribute(`data-${lang}`);
                if (text) {
                    element.textContent = text;
                }
            });
            
            // Update speech recognition language
            if (recognition) {
                recognition.lang = lang === 'hi' ? 'hi-IN' : 'en-IN';
            }
            
            // Save to localStorage
            localStorage.setItem('language', lang);
        }

        function changeTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark');
            } else {
                document.body.classList.remove('dark');
            }
            
            localStorage.setItem('theme', theme);
        }

        async function clearAllData() {
            const pin = document.getElementById('adminPin').value;
            
            if (!pin || pin.length !== 4) {
                showToast('Please enter a 4-digit admin PIN', 'warning');
                return;
            }
            
            const savedPin = localStorage.getItem('adminPin');
            if (savedPin && savedPin !== pin) {
                showToast('Incorrect admin PIN', 'error');
                return;
            }
            
            if (!savedPin) {
                localStorage.setItem('adminPin', pin);
            }
            
            if (confirm('Are you sure you want to delete ALL data? This action cannot be undone.')) {
                try {
                    const transaction = db.transaction(['members'], 'readwrite');
                    const store = transaction.objectStore('members');
                    await store.clear();
                    
                    showToast('All data cleared successfully', 'success');
                    
                    // Refresh all views
                    loadDashboard();
                    loadFamilyView();
                    loadExportImport();
                    updateStorageInfo();
                } catch (error) {
                    showToast('Failed to clear data', 'error');
                    console.error('Clear data error:', error);
                }
            }
        }

        // Form handling
        async function handleMemberSubmit(event) {
            event.preventDefault();
            
            try {
                showLoading('Saving member data...');
                
                // Collect form data
                const memberData = {
                    familyId: document.getElementById('familyIdDisplay').textContent,
                    name: document.getElementById('memberName').value,
                    dob: document.getElementById('memberDob').value,
                    aadhaar: document.getElementById('memberAadhaar').value.replace(/\s/g, ''),
                    gender: document.getElementById('memberGender').value,
                    mobile: document.getElementById('memberMobile').value,
                    caste: document.getElementById('memberCaste').value,
                    maritalStatus: document.getElementById('memberMaritalStatus').value,
                    qualification: document.getElementById('memberQualification').value,
                    relationship: document.getElementById('memberRelationship').value,
                    childCategory: document.getElementById('memberChildCategory').value,
                    deceased: document.getElementById('memberDeceased').value,
                    aadhaarChild: document.getElementById('memberAadhaarChild').value,
                    address: document.getElementById('memberAddress').value,
                    notes: document.getElementById('memberNotes').value,
                    frontImage: document.getElementById('frontImage').src !== window.location.href ? 
                                document.getElementById('frontImage').src : null,
                    backImage: document.getElementById('backImage').src !== window.location.href ? 
                               document.getElementById('backImage').src : null,
                    deathCertificate: null // TODO: Handle death certificate upload
                };
                
                // Validate required fields
                if (!memberData.name || !memberData.dob || !memberData.aadhaar || !memberData.gender || !memberData.caste) {
                    throw new Error('Please fill all required fields');
                }
                
                // Validate Aadhaar
                if (!validateAadhaar(memberData.aadhaar)) {
                    throw new Error('Please enter a valid 12-digit Aadhaar number');
                }
                
                // Check for duplicate Aadhaar
                if (await checkAadhaarExists(memberData.aadhaar)) {
                    throw new Error('This Aadhaar number already exists in the database');
                }
                
                // Save to database
                await addMember(memberData);
                
                hideLoading();
                showToast('Member added successfully!', 'success');
                
                // Reset form
                document.getElementById('memberForm').reset();
                document.getElementById('frontPreview').classList.add('hidden');
                document.getElementById('backPreview').classList.add('hidden');
                document.getElementById('familyIdDisplay').textContent = generateFamilyId();
                
            } catch (error) {
                hideLoading();
                showToast(error.message, 'error');
                console.error('Save member error:', error);
            }
        }

        // Global functions for onclick handlers
        window.editMember = async function(id) {
            // TODO: Implement edit functionality
            showToast('Edit functionality coming soon', 'info');
        };

        window.deleteMemberConfirm = async function(id) {
            if (confirm('Are you sure you want to delete this member?')) {
                try {
                    await deleteMember(id);
                    showToast('Member deleted successfully', 'success');
                    loadFamilyView();
                } catch (error) {
                    showToast('Failed to delete member', 'error');
                    console.error('Delete error:', error);
                }
            }
        };

        window.addFamilyMember = function(familyId) {
            document.getElementById('familyIdDisplay').textContent = familyId;
            switchTab('addMember');
        };

        // PWA Installation
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('pwaInstall').classList.remove('hidden');
        });

        // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
    initializeRecaptcha();

    const sendOtpBtn = document.getElementById('sendOtpBtn');
    const phoneInput = document.getElementById('phoneNumber');
    const otpVerificationContainer = document.getElementById('otpVerificationContainer');
    const phoneAuthContainer = document.getElementById('phoneAuthContainer');

    sendOtpBtn.addEventListener('click', async () => {
        const phoneNumber = phoneInput.value.trim();
        if (!/^\d{10}$/.test(phoneNumber)) {
            showToast("Please enter a valid 10-digit phone number", 'warning');
            return;
        }

        const fullPhone = '+91' + phoneNumber;
        showLoading('Sending OTP...');

        try {
            const appVerifier = window.recaptchaVerifier;
            const result = await signInWithPhoneNumber(auth, fullPhone, appVerifier);
            confirmationResult = result;

            hideLoading();
            showToast("OTP sent successfully!", 'success');
            phoneAuthContainer.classList.add('hidden');
            otpVerificationContainer.classList.remove('hidden');
        } catch (error) {
            hideLoading();
            showToast("Failed to send OTP. Try again.", 'error');
            console.error('Send OTP Error:', error);
        }
    });

    document.getElementById('verifyOtpBtn').addEventListener('click', async () => {
        const code = document.getElementById('otpCode').value.trim();
        if (!/^\d{6}$/.test(code)) {
            showToast("Please enter a valid 6-digit OTP", 'warning');
            return;
        }

        showLoading('Verifying OTP...');

        try {
            const result = await confirmationResult.confirm(code);
            currentUser = result.user;
            hideLoading();
            showToast("Login successful!", 'success');

            document.getElementById('authContainer').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        } catch (error) {
            hideLoading();
            showToast("Invalid OTP. Try again.", 'error');
            console.error('Verify OTP Error:', error);
        }
    });

    document.getElementById('resendOtpBtn').addEventListener('click', () => {
        window.recaptchaVerifier.clear();
        initializeRecaptcha();
        otpVerificationContainer.classList.add('hidden');
        phoneAuthContainer.classList.remove('hidden');
    });
});
                // Initialize IndexedDB
                await initDB();
                
                // Initialize Firebase Auth
                initializeRecaptcha();
                
                // Initialize Speech Recognition
                initSpeechRecognition();
                
                // Check authentication state
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        document.getElementById('authContainer').classList.add('hidden');
                        document.getElementById('mainApp').classList.remove('hidden');
                        document.getElementById('userInfo').textContent = user.phoneNumber;
                        
                        // Load initial data
                        loadDashboard();
                    } else {
                        currentUser = null;
                        document.getElementById('authContainer').classList.remove('hidden');
                        document.getElementById('mainApp').classList.add('hidden');
                    }
                });
                
                // Initialize Family ID
                document.getElementById('familyIdDisplay').textContent = generateFamilyId();
                
                // Load settings from localStorage
                const savedLanguage = localStorage.getItem('language') || 'en';
                const savedTheme = localStorage.getItem('theme') || 'dark';
                
                document.querySelector(`input[name="language"][value="${savedLanguage}"]`).checked = true;
                document.querySelector(`input[name="theme"][value="${savedTheme}"]`).checked = true;
                
                changeLanguage(savedLanguage);
                changeTheme(savedTheme);
                
            } catch (error) {
                console.error('Initialization error:', error);
                showToast('Failed to initialize application', 'error');
            }
        });

        // Auth Event Listeners
        document.getElementById('sendOtpBtn').addEventListener('click', async function() {
            const phoneNumber = document.getElementById('phoneNumber').value;
            
            if (!phoneNumber || phoneNumber.length !== 10) {
                showToast('Please enter a valid 10-digit phone number', 'error');
                return;
            }
            
            try {
                showLoading('Sending OTP...');
                
                const appVerifier = window.recaptchaVerifier;
                confirmationResult = await signInWithPhoneNumber(auth, '+91' + phoneNumber, appVerifier);
                
                document.getElementById('phoneAuthContainer').classList.add('hidden');
                document.getElementById('otpVerificationContainer').classList.remove('hidden');
                
                hideLoading();
                showToast('OTP sent successfully', 'success');
            } catch (error) {
                hideLoading();
                showToast('Failed to send OTP: ' + error.message, 'error');
                console.error('OTP Error:', error);
            }
        });

        document.getElementById('verifyOtpBtn').addEventListener('click', async function() {
            const otpCode = document.getElementById('otpCode').value;
            
            if (!otpCode || otpCode.length !== 6) {
                showToast('Please enter a valid 6-digit OTP', 'error');
                return;
            }
            
            try {
                showLoading('Verifying OTP...');
                
                const result = await confirmationResult.confirm(otpCode);
                const user = result.user;
                
                hideLoading();
                showToast('Login successful!', 'success');
            } catch (error) {
                hideLoading();
                showToast('Invalid OTP. Please try again.', 'error');
                console.error('OTP Verification Error:', error);
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', async function() {
            try {
                await signOut(auth);
                showToast('Logged out successfully', 'success');
            } catch (error) {
                showToast('Logout failed', 'error');
                console.error('Logout error:', error);
            }
        });

        // Tab Navigation
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                switchTab(tabName);
            });
        });

        // File Upload Handlers
        document.getElementById('aadhaarFront').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('frontImage').src = e.target.result;
                    document.getElementById('frontPreview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('aadhaarBack').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('backImage').src = e.target.result;
                    document.getElementById('backPreview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // Camera Buttons
        document.getElementById('captureFont').addEventListener('click', () => startCamera('front'));
        document.getElementById('captureBack').addEventListener('click', () => startCamera('back'));
        document.getElementById('captureBtn').addEventListener('click', capturePhoto);
        document.getElementById('closeCameraBtn').addEventListener('click', closeCamera);

        // Crop Buttons
        document.getElementById('cropFront').addEventListener('click', () => {
            currentCameraType = 'front';
            initCropper(document.getElementById('frontImage'));
        });
        
        document.getElementById('cropBack').addEventListener('click', () => {
            currentCameraType = 'back';
            initCropper(document.getElementById('backImage'));
        });
        
        document.getElementById('rotateLeft').addEventListener('click', () => rotateCropper(-90));
        document.getElementById('rotateRight').addEventListener('click', () => rotateCropper(90));
        document.getElementById('cropConfirm').addEventListener('click', confirmCrop);
        document.getElementById('cropCancel').addEventListener('click', closeCropModal);

        // OCR Button
        document.getElementById('extractDataBtn').addEventListener('click', extractAadhaarData);

        // Form Submit
        document.getElementById('memberForm').addEventListener('submit', handleMemberSubmit);

        // Speech Recognition Buttons
        document.querySelectorAll('.speech-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const fieldId = this.getAttribute('data-field');
                startSpeechRecognition(fieldId);
            });
        });

        // Aadhaar Formatting
        document.getElementById('memberAadhaar').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '');
            if (value.length <= 12) {
                e.target.value = value.replace(/(\d{4})(\d{4})(\d{4})/, '$1 $2 $3').trim();
            }
        });

        // Deceased field change handler
        document.getElementById('memberDeceased').addEventListener('change', function() {
            const deathCertSection = document.getElementById('deathCertificateSection');
            if (this.value === 'Yes') {
                deathCertSection.classList.remove('hidden');
            } else {
                deathCertSection.classList.add('hidden');
            }
        });

        // Dashboard Filters
        document.querySelectorAll('#dashboard select[id^="filter"]').forEach(filter => {
            filter.addEventListener('change', loadDashboard);
        });

        // Family View Buttons
        document.getElementById('listViewBtn').addEventListener('click', function() {
            document.getElementById('familyListView').classList.remove('hidden');
            document.getElementById('familyTreeView').classList.add('hidden');
            this.classList.add('bg-blue-600');
            document.getElementById('treeViewBtn').classList.remove('bg-blue-600');
        });

        document.getElementById('treeViewBtn').addEventListener('click', async function() {
            const members = await getAllMembers();
            displayFamilyTree(members);
            document.getElementById('familyListView').classList.add('hidden');
            document.getElementById('familyTreeView').classList.remove('hidden');
            this.classList.add('bg-blue-600');
            document.getElementById('listViewBtn').classList.remove('bg-blue-600');
        });

        document.getElementById('familyFilter').addEventListener('change', async function() {
            const members = await getAllMembers();
            const filteredMembers = this.value ? 
                members.filter(m => m.familyId === this.value) : members;
            displayFamilyList(filteredMembers);
        });

        // Export/Import Buttons
        document.getElementById('exportExcel').addEventListener('click', exportToExcel);
        document.getElementById('exportJson').addEventListener('click', exportToJson);
        document.getElementById('importData').addEventListener('click', importData);

        // Select All Checkbox
        document.getElementById('selectAll').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.record-checkbox');
            checkboxes.forEach(cb => cb.checked = this.checked);
        });

        // Settings Event Listeners
        document.querySelectorAll('input[name="language"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    changeLanguage(this.value);
                }
            });
        });

        document.querySelectorAll('input[name="theme"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    changeTheme(this.value);
                }
            });
        });

        document.getElementById('clearAllData').addEventListener('click', clearAllData);

        // Floating Action Button
        document.getElementById('floatingBtn').addEventListener('click', function() {
            switchTab('addMember');
        });

        // PWA Install Button
        document.getElementById('installBtn').addEventListener('click', async function() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                document.getElementById('pwaInstall').classList.add('hidden');
            }
        });

        // Prevent right-click and screenshots (optional)
        document.addEventListener('contextmenu', function(e) {
            if (document.getElementById('preventScreenshot').checked) {
                e.preventDefault();
            }
        });

        // Disable certain key combinations
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('preventScreenshot').checked) {
                if ((e.ctrlKey && (e.key === 'p' || e.key === 's' || e.key === 'u')) ||
                    (e.key === 'F12') ||
                    (e.ctrlKey && e.shiftKey && e.key === 'I')) {
                    e.preventDefault();
                }
            }
        });

        // Service Worker Registration (PWA)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => console.log('SW registered'))
                .catch(error => console.log('SW registration failed'));
        }
    </script>

    <!-- Service Worker (embedded) -->
    <script>
        // Create and register service worker for PWA
        const swCode = `
            const CACHE_NAME = 'aadhaar-survey-v1';
            const urlsToCache = [
                '/',
                '/index.html'
            ];

            self.addEventListener('install', function(event) {
                event.waitUntil(
                    caches.open(CACHE_NAME)
                        .then(function(cache) {
                            return cache.addAll(urlsToCache);
                        })
                );
            });

            self.addEventListener('fetch', function(event) {
                event.respondWith(
                    caches.match(event.request)
                        .then(function(response) {
                            if (response) {
                                return response;
                            }
                            return fetch(event.request);
                        }
                    )
                );
            });
        `;

        // Create service worker blob and register
        if ('serviceWorker' in navigator) {
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl)
                .then(registration => console.log('Service Worker registered'))
                .catch(error => console.log('Service Worker registration failed:', error));
        }
    </script>

    <!-- Web App Manifest (embedded) -->
    <script>
        const manifest = {
            "name": "Aadhaar Family Survey App",
            "short_name": "Aadhaar Survey",
            "description": "Complete family survey application with Aadhaar card scanning",
            "start_url": "/",
            "display": "standalone",
            "background_color": "#1e293b",
            "theme_color": "#3b82f6",
            "orientation": "portrait",
            "icons": [
                {
                    "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' fill='%233b82f6'/%3E%3Ctext x='32' y='40' font-family='Arial' font-size='32' fill='white' text-anchor='middle'%3EA%3C/text%3E%3C/svg%3E",
                    "sizes": "64x64",
                    "type": "image/svg+xml"
                },
                {
                    "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' fill='%233b82f6'/%3E%3Ctext x='96' y='120' font-family='Arial' font-size='96' fill='white' text-anchor='middle'%3EA%3C/text%3E%3C/svg%3E",
                    "sizes": "192x192",
                    "type": "image/svg+xml"
                },
                {
                    "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%233b82f6'/%3E%3Ctext x='256' y='320' font-family='Arial' font-size='256' fill='white' text-anchor='middle'%3EA%3C/text%3E%3C/svg%3E",
                    "sizes": "512x512",
                    "type": "image/svg+xml"
                }
            ]
        };

        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const manifestUrl = URL.createObjectURL(manifestBlob);
        
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = manifestUrl;
        document.head.appendChild(link);
    </script>
</body>
</html>
